<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Loan Calculator</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ==== Basic reset + fonts ==== */
    :root{
      --accent:#1f6fa8;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f7f9fb;
      --panel:#f0f4f7;
      --radius:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#111;background:var(--bg);-webkit-font-smoothing:antialiased;touch-action:pan-y}
    a{color:var(--accent);text-decoration:none}

    /* ==== Page container ==== */
    .wrap{max-width:980px;margin:18px auto;padding:18px}

    header{margin-bottom:14px}
    h1{font-size:40px;margin:0 0 6px;color:var(--accent)}
    p.lead{margin:0 0 12px;color:var(--muted);font-size:15px}

    /* ==== Layout grid ==== */
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(13,30,43,0.06)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start}
    @media(max-width:960px){ .grid{grid-template-columns:1fr} }

    /* ==== Form layout ==== */
    .form{display:block}
    .section-title{font-weight:700;margin:6px 0 10px;color:#374151}
    .row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .col{flex:1}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    input[type="number"], input[type="text"], select{
      width:100%;padding:14px;border:1px solid #e6edf3;border-radius:6px;font-size:16px;background:#fff
    }
    .small{font-size:13px;color:var(--muted)}
    .btn{display:inline-block;padding:10px 18px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e6edf3}

    /* ==== Results / stats ==== */
    .results{display:grid;gap:12px;margin-top:12px;grid-template-columns:1fr;align-items:start}
    .stat{background:#fff;padding:12px;border-radius:8px;border:1px solid #eef3f7}
    .stat h3{margin:0;font-size:18px;color:var(--accent)}
    .stat p{margin:6px 0 0;color:var(--muted)}

    /* ==== charts and schedule ==== */
    .visual{display:block;margin-top:16px}
    canvas{background:#fff;border-radius:8px;padding:12px;display:block;width:100%;height:260px}
    .donut{max-width:320px;margin:18px auto}
    .schedule{margin-top:22px}
    .tabs{display:flex;gap:12px;margin-bottom:8px}
    .tabs a{padding:6px 10px;border-radius:6px;background:#fff;border:1px solid #e6edf3;color:var(--accent)}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:6px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
    th{background:#2f6d95;color:#fff;font-weight:700}
    .annual{max-width:620px;margin-top:10px}

    /* small helpers */
    .muted{color:var(--muted)}
    .right{text-align:right}
    .big{font-size:22px;font-weight:700;color:#0f172a}

    /* responsive tweaks */
    @media(max-width:760px){
      h1{font-size:32px}
      .grid{grid-template-columns:1fr}
      canvas{height:220px}
      .donut{max-width:260px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Auto Loan Calculator</h1>
      <p class="lead">Calculate monthly payments, amortization schedule, taxes & fees, and view charts.</p>
    </header>

    <div class="grid">
      <!-- LEFT: Form -->
      <div class="card">
        <form id="calcForm" class="form" onsubmit="return false;">
          <div class="section-title">Total Price</div>

          <div class="row">
            <div class="col">
              <label>Auto Price</label>
              <input id="price" type="number" value="50000" min="0" step="1" />
            </div>
            <div style="width:120px">
              <label>Down Payment</label>
              <input id="down" type="number" value="10000" min="0" step="1" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Loan Term</label>
              <input id="term" type="number" value="60" min="1" step="1" />
              <div class="small muted">months</div>
            </div>
            <div style="width:140px">
              <label>Interest Rate</label>
              <input id="rate" type="number" value="5" min="0" step="0.001" />
              <div class="small muted">annual %</div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Sales Tax (%)</label>
              <input id="tax" type="number" value="7" min="0" step="0.01" />
            </div>
            <div style="width:140px">
              <label>Fees</label>
              <input id="fees" type="number" value="2000" min="0" step="1" />
            </div>
          </div>

          <div style="margin-top:8px;">
            <label class="small">Options</label><br>
            <label style="display:inline-flex;align-items:center;gap:8px;margin-top:8px">
              <input id="includeFees" type="checkbox" />
              <span class="small">Include taxes & fees in the loan</span>
            </label>
          </div>

          <div style="margin-top:14px">
            <button id="calcBtn" class="btn" type="button">Calculate</button>
            <button id="resetBtn" class="btn secondary" type="button" style="margin-left:8px">Reset</button>
          </div>

          <div class="results">
            <div class="stat">
              <h3>Vehicle Price</h3>
              <p class="big" id="outVehicle">$0</p>
            </div>

            <div class="stat">
              <h3>Total Loan Amount</h3>
              <p id="outLoan" class="big">$0</p>
            </div>

            <div class="stat">
              <h3>Monthly Payment</h3>
              <p id="outMonthly" class="big">$0</p>
            </div>
          </div>
        </form>
      </div>

      <!-- RIGHT: Visuals -->
      <div>
        <div class="card visual">
          <canvas id="lineChart"></canvas>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px">
            <div class="donut card">
              <canvas id="donutChart"></canvas>
            </div>
            <div style="flex:1">
              <div class="big muted">Summary</div>
              <div style="margin-top:8px">
                <div style="display:flex;justify-content:space-between"><div>Total of payments</div><div id="sumPayments" class="big">$0</div></div>
                <div style="display:flex;justify-content:space-between"><div>Total interest</div><div id="sumInterest" class="muted">$0</div></div>
                <div style="display:flex;justify-content:space-between"><div>Estimated total cost</div><div id="sumCost" class="big">$0</div></div>
              </div>
            </div>
          </div>

          <div class="schedule">
            <div style="display:flex;justify-content:space-between;align-items:end">
              <div class="annual">
                <div style="display:flex;gap:14px;align-items:center">
                  <a class="tabs" href="#" id="showAnnual">Annual Schedule</a>
                  <a class="tabs" href="#" id="showMonthly">Monthly Schedule</a>
                </div>
              </div>
            </div>

            <div id="annualArea" style="margin-top:8px">
              <table id="annualTable">
                <thead>
                  <tr><th>Year</th><th>Interest</th><th>Principal</th><th>Ending Balance</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div id="monthlyArea" style="display:none;margin-top:10px">
              <table id="monthlyTable">
                <thead><tr><th>Payment #</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Utility formatting ===== */
function fmt(n){ return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function money(n){ return '$' + fmt(n); }

/* ===== Main calculation ===== */
function calculate(){
  const price = parseFloat(document.getElementById('price').value) || 0;
  const down = parseFloat(document.getElementById('down').value) || 0;
  const term = parseInt(document.getElementById('term').value) || 0; // months
  const rateA = parseFloat(document.getElementById('rate').value) || 0; // annual %
  const taxPct = parseFloat(document.getElementById('tax').value) || 0;
  const fees = parseFloat(document.getElementById('fees').value) || 0;
  const includeFees = document.getElementById('includeFees').checked;

  // Compute tax amount on price (simple)
  const taxAmount = (taxPct/100) * price;
  const vehicleDisplay = price;
  let loanAmount = Math.max(0, price - down);

  // include fees & tax in loan if selected
  if(includeFees){
    loanAmount += (fees + taxAmount);
  }

  // monthly rate
  const monthlyRate = (rateA/100)/12;
  let monthlyPayment = 0;
  if(monthlyRate > 0){
    monthlyPayment = loanAmount * (monthlyRate / (1 - Math.pow(1+monthlyRate, -term)));
  } else {
    monthlyPayment = loanAmount / Math.max(1, term);
  }

  // amortization monthly schedule
  const monthlySchedule = [];
  let balance = loanAmount;
  let totalInterest = 0;
  for(let i=1;i<=term;i++){
    const interest = balance * monthlyRate;
    const principal = Math.min(balance, monthlyPayment - interest);
    const payment = principal + interest;
    balance = Math.max(0, balance - principal);
    totalInterest += interest;
    monthlySchedule.push({i,payment,principal,interest,balance});
  }

  const totalPayments = monthlySchedule.reduce((s,r)=>s+r.payment,0);
  const totalCost = (includeFees ? 0 : (fees + taxAmount)) + totalPayments + (includeFees?0:0); // note: if fees not included, add them to cost

  // annual schedule (aggregate monthly schedule by year)
  const annual = [];
  for(let i=0;i<monthlySchedule.length;i++){
    const yr = Math.floor(i/12);
    annual[yr] = annual[yr] || {year:yr+1, interest:0, principal:0, ending:0};
    annual[yr].interest += monthlySchedule[i].interest;
    annual[yr].principal += monthlySchedule[i].principal;
    annual[yr].ending = monthlySchedule[i].balance;
  }

  // update DOM
  document.getElementById('outVehicle').textContent = money(vehicleDisplay);
  document.getElementById('outLoan').textContent = money(loanAmount);
  document.getElementById('outMonthly').textContent = money(monthlyPayment);
  document.getElementById('sumPayments').textContent = money(totalPayments);
  document.getElementById('sumInterest').textContent = money(totalInterest);
  const estTotalCost = (includeFees ? totalPayments : totalPayments + fees + taxAmount);
  document.getElementById('sumCost').textContent = money(estTotalCost);

  // draw charts
  drawLineChart(monthlySchedule);
  drawDonutChart(monthlySchedule);

  // fill tables
  fillMonthlyTable(monthlySchedule);
  fillAnnualTable(annual);

  // send height to parent for iframe auto-size
  sendHeightToParent();

  // return data in case caller wants it
  return {monthlySchedule,annual,loanAmount,monthlyPayment,totalPayments,totalInterest,estTotalCost};
}

/* ===== Tables and charts ===== */
function fillMonthlyTable(rows){
  const tbody = document.querySelector('#monthlyTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.i}</td>
                    <td>${money(r.payment)}</td>
                    <td>${money(r.principal)}</td>
                    <td>${money(r.interest)}</td>
                    <td>${money(r.balance)}</td>`;
    tbody.appendChild(tr);
  });
}

function fillAnnualTable(years){
  const tbody = document.querySelector('#annualTable tbody');
  tbody.innerHTML = '';
  years.forEach(y=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${y.year}</td>
                    <td>${money(y.interest)}</td>
                    <td>${money(y.principal)}</td>
                    <td>${money(y.ending)}</td>`;
    tbody.appendChild(tr);
  });
}

/* Charts */
let lineChart=null, donutChart=null;
function drawLineChart(monthlySchedule){
  const labels = [];
  const balance = [];
  const interestAccum = [];
  let accum = 0;
  for(let i=0;i<monthlySchedule.length;i++){
    labels.push((i+1).toString());
    balance.push(monthlySchedule[i].balance);
    accum += monthlySchedule[i].interest;
    interestAccum.push(accum);
  }

  const ctx = document.getElementById('lineChart').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Balance', data: balance, borderColor:'#2b7be4', backgroundColor:'rgba(43,123,228,0.06)', fill:false, tension:0.2},
        {label:'Interest (cum)', data: interestAccum, borderColor:'#7ac74f', backgroundColor:'rgba(122,199,79,0.06)', fill:false, tension:0.2},
        {label:'Payment', data: labels.map((l,i)=>monthlySchedule[i].payment), borderColor:'#a6292b', backgroundColor:'rgba(166,41,43,0.06)', fill:false, tension:0.2}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'right'}}
    }
  });
}

function drawDonutChart(monthlySchedule){
  const totalInterest = monthlySchedule.reduce((s,r)=>s+r.interest,0);
  const totalPrincipal = monthlySchedule.reduce((s,r)=>s+r.principal,0);
  const ctx = document.getElementById('donutChart').getContext('2d');
  if(donutChart) donutChart.destroy();
  donutChart = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['Principal','Interest'],
      datasets:[{data:[totalPrincipal,totalInterest], backgroundColor:['#2b7be4','#7ac74f']}]
    },
    options:{plugins:{legend:{position:'right'}}}
  });
}

/* ===== UI wiring ===== */
document.getElementById('calcBtn').addEventListener('click', ()=>{ calculate(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('price').value = 50000;
  document.getElementById('down').value = 10000;
  document.getElementById('term').value = 60;
  document.getElementById('rate').value = 5;
  document.getElementById('tax').value = 7;
  document.getElementById('fees').value = 2000;
  document.getElementById('includeFees').checked = false;
  calculate();
});

document.getElementById('showAnnual').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('annualArea').style.display='block'; document.getElementById('monthlyArea').style.display='none';});
document.getElementById('showMonthly').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('annualArea').style.display='none'; document.getElementById('monthlyArea').style.display='block';});

/* init */
window.addEventListener('load', ()=>{ calculate(); });

/* ===== Auto-height postMessage to parent (for iframe auto-resize) ===== */
function sendHeightToParent(){
  try{
    const h = document.documentElement.scrollHeight || document.body.scrollHeight;
    parent.postMessage({type:'autoloan-height', h: h}, '*');
  }catch(e){ /* ignore */ }
}
// send periodic updates too
setInterval(sendHeightToParent, 800);

/* also send when content changes (simple) */
new MutationObserver(sendHeightToParent).observe(document.body, {childList:true, subtree:true, attributes:true});
</script>
</body>
</html>
