<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auto Loan Calculator — Fixvity</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f7fbfd;
    --card:#ffffff;
    --accent:#1f6fb6;
    --muted:#6b7280;
    --radius:12px;
    --shadow: 0 8px 28px rgba(10,20,30,0.06);
    --container-max:1100px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#111;background:var(--bg);-webkit-font-smoothing:antialiased}
  a{color:var(--accent);text-decoration:none}

  /* container */
  .wrap{max-width:var(--container-max);margin:22px auto;padding:18px;overflow-x:hidden;}
  header h1{margin:0;font-size:36px;color:var(--accent)}
  header p.lead{margin:8px 0 18px;color:var(--muted);font-size:16px}

  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px;overflow:hidden}

  /* grid layout: form left, results right on wide screens */
  .grid{display:grid;gap:18px;grid-template-columns: 1fr 430px;}
  @media (max-width:1024px){ .grid{grid-template-columns:1fr;} }

  /* form controls */
  .form-row{display:flex;gap:12px}
  .col{flex:1;min-width:0}
  .form-group{margin-bottom:12px}
  label{display:block;font-size:14px;color:var(--muted);margin-bottom:8px}
  input[type="text"], input[type="number"], select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px;background:#fff}
  .small{font-size:13px;color:var(--muted)}

  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{display:inline-block;padding:10px 16px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.alt{background:#eef6fb;color:var(--accent);border:1px solid #dfeffb}

  /* results area */
  .results{display:flex;flex-direction:column;gap:14px}
  .result-row{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px;border-radius:8px;border:1px solid #f1f5f9}
  .result-row h3{margin:0;color:var(--accent);font-size:16px}
  .result-row .value{font-weight:700;font-size:18px}

  /* charts */
  .chartWrap{background:var(--card);padding:12px;border-radius:8px;box-shadow:var(--shadow);overflow:hidden}
  .chartBox{height:260px}
  .chartBox.tall{height:300px}
  @media (max-width:600px){
    .chartBox{height:220px}
    .chartBox.tall{height:260px}
  }

  /* ensure canvases stay inside container */
  canvas{max-width:100% !important; height:auto !important; display:block; }

  /* schedule table */
  .tableWrap{margin-top:10px;overflow:auto;background:transparent}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#2f6b9f;color:#fff}
  .tableToggle{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .tabBtn{padding:10px 14px;border-radius:8px;border:1px solid #dfe6ee;background:#f7fbff;cursor:pointer}
  .tabBtn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* responsive tweaks: tiny screens */
  @media (max-width:480px){
    header h1{font-size:28px}
    input[type="number"], input[type="text"]{font-size:15px;padding:10px}
    .chartBox{height:200px}
  }

  /* NEW: mobile alignment fix */
  @media (max-width:600px){
    .grid{ grid-template-columns:1fr; }         /* form above, results below */
    .form-row{ flex-direction:column; gap:10px; }/* stack fields vertically */
    .form-row .col{ width:100%; min-width:0; }  /* prevent flex overflow */
  }

  /* print */
  @media print{
    .controls, label, .small, .tabBtn { display:none !important; }
    body{background:#fff}
    .wrap{max-width:100%;padding:0}
  }
</style>
</head>
<body>
  <div class="wrap">

    <header>
      <h1>Auto Loan Calculator</h1>
      <p class="lead">Monthly payment, amortization schedule, charts, and printable results. Select currency and view annual or monthly breakdowns.</p>
    </header>

    <!-- main card: currency top + form + results -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px">
        <div style="flex:1;min-width:220px">
          <label for="currencyTop">Currency & Format</label>
          <select id="currencyTop" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8">
            <option value="USD">USD - $</option>
            <option value="EUR">EUR - €</option>
            <option value="CAD">CAD - $</option>
            <option value="GBP">GBP - £</option>
            <option value="JPY">JPY - ¥</option>
            <option value="INR">INR - ₹</option>
          </select>
          <div class="small" style="margin-top:6px">Exchange rates are example values — change in code if needed.</div>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT: form -->
        <div>
          <form id="loanForm" onsubmit="return false;">
            <div class="form-group">
              <label for="price">Auto Price</label>
              <input id="price" type="number" min="0" value="50000" />
            </div>

            <div class="form-row" style="margin-bottom:8px">
              <div class="col form-group">
                <label for="term">Loan Term (months)</label>
                <input id="term" type="number" min="1" value="60" />
              </div>
              <div class="col form-group">
                <label for="rate">Interest Rate (%)</label>
                <input id="rate" type="number" step="0.001" value="5" min="0" />
              </div>
            </div>

            <div class="form-group">
              <label for="cash">Cash incentives</label>
              <input id="cash" type="number" value="0" />
            </div>

            <div class="form-row">
              <div class="col form-group">
                <label for="down">Down Payment</label>
                <input id="down" type="number" value="10000" />
              </div>
              <div class="col form-group">
                <label for="tradeValue">Trade-in Value</label>
                <input id="tradeValue" type="number" value="0" />
              </div>
            </div>

            <div class="form-row">
              <div class="col form-group">
                <label for="owedTrade">Amount Owed on Trade</label>
                <input id="owedTrade" type="number" value="0" />
              </div>
              <div class="col form-group" style="display:none"></div>
            </div>

            <div class="form-row">
              <div class="col form-group">
                <label for="salesTax">Sales Tax (%)</label>
                <input id="salesTax" type="number" step="0.01" value="7" />
              </div>
              <div class="col form-group">
                <label for="fees">Title / Registration / Fees ($)</label>
                <input id="fees" type="number" value="2000" />
              </div>
            </div>

            <div class="form-group">
              <label for="note">Notes</label>
              <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <button class="btn" id="calc">Calculate</button>
                <button class="btn alt" id="reset">Reset</button>
                <button class="btn alt" id="printBtn">Print</button>
                <button class="btn alt" id="csv">Download CSV</button>
              </div>
              <div class="small">Tip: fees/tax are included in the loan calculation by default for consistent totals. Edit code to change this behavior.</div>
            </div>
          </form>
        </div>

        <!-- RIGHT: results & charts -->
        <div class="results">
          <div class="result-row">
            <div>
              <h3>Vehicle Price</h3>
              <div class="small">Loan details & results</div>
            </div>
            <div class="value" id="vehiclePriceVal">$0.00</div>
          </div>

          <div class="result-row">
            <div>
              <div class="small">Total Loan Amount</div>
              <h3 id="totalLoanVal">$0.00</h3>
            </div>
            <div>
              <div class="small">Monthly Payment</div>
              <h3 id="monthlyVal">$0.00</h3>
            </div>
          </div>

          <div class="chartWrap">
            <div class="chartBox tall">
              <canvas id="donut"></canvas>
            </div>
          </div>

          <div class="chartWrap">
            <div class="chartBox">
              <canvas id="amort"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule card -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <h2 style="margin:0">Amortization schedule</h2>
          <div class="small">View annual summary or monthly detailed schedule</div>
        </div>
        <div class="tableToggle">
          <button class="tabBtn active" id="btnAnnual">Annual Schedule</button>
          <button class="tabBtn" id="btnMonthly">Monthly Schedule</button>
        </div>
      </div>

      <div id="scheduleWrap" class="tableWrap card" style="margin-top:12px;padding:12px"></div>
    </div>
  </div>

<script>
/* currency formatting map */
const currencyLocales = {
  USD: { locale: 'en-US', currency: 'USD' },
  EUR: { locale: 'de-DE', currency: 'EUR' },
  CAD: { locale: 'en-CA', currency: 'CAD' },
  GBP: { locale: 'en-GB', currency: 'GBP' },
  JPY: { locale: 'ja-JP', currency: 'JPY' },
  INR: { locale: 'en-IN', currency: 'INR' }
};
function moneyFmt(amount, code='USD'){
  const cfg = currencyLocales[code] || currencyLocales.USD;
  try {
    return new Intl.NumberFormat(cfg.locale, { style:'currency', currency: cfg.currency, maximumFractionDigits:2 }).format(amount);
  } catch(e){
    return Number(amount).toFixed(2);
  }
}

/* short DOM helper */
const $ = id => document.getElementById(id);

/* inputs object for easy reference */
const inputs = {
  price: $('price'),
  term: $('term'),
  rate: $('rate'),
  cash: $('cash'),
  down: $('down'),
  tradeValue: $('tradeValue'),
  owedTrade: $('owedTrade'),
  salesTax: $('salesTax'),
  fees: $('fees'),
  currencyTop: $('currencyTop'),
  calcBtn: $('calc'),
  resetBtn: $('reset'),
  printBtn: $('printBtn'),
  csvBtn: $('csv')
};

let donutChart = null;
let amortChart = null;

/* create charts */
function createCharts(){
  const donutCtx = $('donut').getContext('2d');
  donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: { labels: ['Principal','Interest'], datasets: [{ data: [1,1], backgroundColor: ['#1f77b4','#7ac142'] }]},
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}}
  });

  const amortCtx = $('amort').getContext('2d');
  amortChart = new Chart(amortCtx, {
    type:'line',
    data:{
      labels:[],
      datasets:[
        {label:'Balance', data:[], borderColor:'#1f77b4', fill:false, pointRadius:3},
        {label:'Interest', data:[], borderColor:'#7ac142', fill:false, pointRadius:2},
        {label:'Payment', data:[], borderColor:'#d44', fill:false, pointRadius:2}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ title:{display:true, text:'Month'} },
        y:{ title:{display:false} }
      },
      plugins:{legend:{position:'top'}}
    }
  });
}

/* main calculate function */
function calculate(e){
  if(e && e.preventDefault) e.preventDefault();

  const currency = inputs.currencyTop.value || 'USD';
  const price = Number(inputs.price.value) || 0;
  const term = Math.max(1, parseInt(inputs.term.value || 0));
  const annualRate = Number(inputs.rate.value) || 0;
  const monthlyRate = annualRate/100/12;
  const cash = Number(inputs.cash.value) || 0;
  const down = Number(inputs.down.value) || 0;
  const trade = Number(inputs.tradeValue.value) || 0;
  const owedTrade = Number(inputs.owedTrade.value) || 0;
  const salesTax = Number(inputs.salesTax.value) || 0;
  const fees = Number(inputs.fees.value) || 0;

  // taxable base and loan amount
  const taxableBase = Math.max(0, price - cash - down - trade + owedTrade);
  const salesTaxAmount = taxableBase * (salesTax/100);
  const loanAmount = taxableBase + salesTaxAmount + fees;

  // monthly payment
  let monthlyPayment = 0;
  if (monthlyRate === 0) {
    monthlyPayment = loanAmount / term;
  } else {
    monthlyPayment = loanAmount * (monthlyRate / (1 - Math.pow(1+monthlyRate, -term)));
  }

  // build month schedule
  const schedule = [];
  let balance = loanAmount;
  let totalInterest = 0;
  for (let m=1; m<=term; m++){
    const interest = balance * monthlyRate;
    const principal = Math.min(balance, monthlyPayment - interest);
    const payment = interest + principal;
    balance = Math.max(0, balance - principal);
    totalInterest += interest;
    schedule.push({ month: m, payment, principal, interest, balance });
  }

  // annual summary
  const annual = {};
  schedule.forEach(r=>{
    const y = Math.ceil(r.month/12);
    if(!annual[y]) annual[y] = { interest:0, principal:0, ending:0 };
    annual[y].interest += r.interest;
    annual[y].principal += r.principal;
    annual[y].ending = r.balance;
  });

  // update UI values
  $('vehiclePriceVal').textContent = moneyFmt(price, currency);
  $('totalLoanVal').textContent = moneyFmt(loanAmount, currency);
  $('monthlyVal').textContent = moneyFmt(monthlyPayment, currency);

  // update charts
  if (donutChart){
    donutChart.data.datasets[0].data = [loanAmount, totalInterest];
    donutChart.update();
  }
  if (amortChart){
    amortChart.data.labels = schedule.map(r=>String(r.month));
    amortChart.data.datasets[0].data = schedule.map(r=>r.balance);
    amortChart.data.datasets[1].data = schedule.map(r=>r.interest);
    amortChart.data.datasets[2].data = schedule.map(r=>r.payment);
    amortChart.update();
  }

  // render schedule tables
  buildSchedule(schedule, annual, currency);
}

/* build HTML schedule tables and attach toggles + CSV handler */
function buildSchedule(monthly, annual, currency){
  const wrap = $('scheduleWrap');

  // annual table html
  let annHtml = '<div id="annualTable"><table><thead><tr><th>Year</th><th>Interest</th><th>Principal</th><th>Ending Balance</th></tr></thead><tbody>';
  Object.keys(annual).sort((a,b)=>a-b).forEach(y=>{
    annHtml += `<tr><td>${y}</td><td>${moneyFmt(annual[y].interest,currency)}</td><td>${moneyFmt(annual[y].principal,currency)}</td><td>${moneyFmt(annual[y].ending,currency)}</td></tr>`;
  });
  annHtml += '</tbody></table></div>';

  // monthly table html
  let monHtml = '<div id="monthlyTable" style="display:none"><table><thead><tr><th>Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Ending Balance</th></tr></thead><tbody>';
  monthly.forEach(r=>{
    monHtml += `<tr><td>${r.month}</td><td>${moneyFmt(r.payment,currency)}</td><td>${moneyFmt(r.principal,currency)}</td><td>${moneyFmt(r.interest,currency)}</td><td>${moneyFmt(r.balance,currency)}</td></tr>`;
  });
  monHtml += '</tbody></table></div>';

  wrap.innerHTML = annHtml + monHtml;

  // toggle buttons
  const btnA = $('btnAnnual');
  const btnM = $('btnMonthly');
  btnA.classList.add('active'); btnM.classList.remove('active');

  btnA.onclick = () => {
    $('annualTable').style.display = 'block';
    $('monthlyTable').style.display = 'none';
    btnA.classList.add('active'); btnM.classList.remove('active');
  };
  btnM.onclick = () => {
    $('annualTable').style.display = 'none';
    $('monthlyTable').style.display = 'block';
    btnM.classList.add('active'); btnA.classList.remove('active');
  };

  // single CSV handler (safe, working)
  inputs.csvBtn.onclick = () => {
    const rows = [['Month','Payment','Principal','Interest','EndingBalance']];
    monthly.forEach(r => rows.push([
      r.month,
      r.payment.toFixed(2),
      r.principal.toFixed(2),
      r.interest.toFixed(2),
      r.balance.toFixed(2)
    ]));
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'amortization_monthly.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
}

/* reset defaults */
function resetForm(e){
  if(e && e.preventDefault) e.preventDefault();
  inputs.price.value = 50000;
  inputs.term.value = 60;
  inputs.rate.value = 5;
  inputs.cash.value = 0;
  inputs.down.value = 10000;
  inputs.tradeValue.value = 0;
  inputs.owedTrade.value = 0;
  inputs.salesTax.value = 7;
  inputs.fees.value = 2000;
  inputs.currencyTop.value = 'USD';
  calculate();
}

/* init on load */
window.addEventListener('load', ()=>{
  createCharts();

  // single wiring (no duplicates)
  inputs.calcBtn.addEventListener('click', calculate);
  inputs.resetBtn.addEventListener('click', resetForm);
  inputs.printBtn.addEventListener('click', ()=>window.print());

  // initial render
  resetForm();

  // safe resize handler (correct donut resize)
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (amortChart) amortChart.resize();
      if (donutChart) donutChart.resize();
    }, 150);
  });
});
</script>
</body>
</html>
